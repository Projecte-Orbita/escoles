---
title: "Pooling"
author: "Eudald Correig"
date: "24/8/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
n <- 12
p <- .001
m <- 10
l <- 3
```

```{r}
ppois(0, p*m)

plot(0:20, dpois(0:20, p*m))

dpois(10, p*m)
no_infectats <- function(p, m = 20) {
  dpois(0, p*m)
}
no_infectats(.002)
```


Donada una prevalença "p", la probabilitat de que k membres d'una mostra de N estiguin infectats ve donat per una distribució de poission amb $\lambda = pm$.

Per tant, en cada classe de 20 alumnes, la probabilitat de que no hi hagi cap infectat amb una prevalença del 2% és del 67%. Per tant, dues terceres parts de les classes no hauran de fer cap més test. 

Per les classes que donen positiu, segons https://arxiv.org/pdf/2004.14934.pdf, hauríem de fer cubs de 3x3x3, de manera que amb 9 tests podem mesurar tota la mostra. De totes maneres, com que les nostres classes són de 20, amb una graella de 5*4 tenim el mateix nombre de tests (9) i ja arribem a les 20 persones. Si el número passa de 20, passem al cub.

```{r}
calcul_tests <- function(prev, num_classes, alumnes_per_clase) {
  num_classes * (1 + (1 - ppois(0, prev * alumnes_per_clase)) * 9)
  
}
```

```{r}
df <- cbind.data.frame("prev" = seq(.1, 5, by = .1), 
                       "num" = calcul_tests(seq(.1, 5, by = .1)/100, 
                                            num_classes = 15, 
                                            alumnes_per_clase = 20))
df$num <- ceiling(df$num)
```

```{r}
library(ggplot2)
ggplot(df, aes(x = prev, y = num)) + 
  geom_point() + 
  theme_bw() +
  xlab("Prevalença (%)") + 
  ylab("Número de test") + 
  ggtitle("Número de tests segons la prevalença en una escola de 15 classes")
```

