---
title: "Anàlisis evolució COVID escoles"
author: "Projecte Òrbita"
date: "23/10/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lubridate)
library(RSocrata)
library(dplyr)
library(tidyr)
library(plotly)
enc <- "UTF-8"
```

```{r}
# TODO: get from other code
import_covid <- function(start, end) {
  # Import COVID cases from API
  # TODO: filter by date already in the query
  p <- "https://analisi.transparenciacatalunya.cat/resource/jj6z-iyrp.json"
  q <- "?$where=resultatcoviddescripcio='Positiu PCR'"
  l <- paste0(p, q)
  covid <- read.socrata(l, stringsAsFactors = F)

  covid$data <- ymd(covid$data)
  covid <- covid[(covid$data > start & covid$data < end), ]

  covid
}
```

```{r}
# define vars
start_schools <- ymd("2020-09-14")
today <- today()
correction <- 3
```

```{r}
# get population covid data
df_pop <- import_covid(start_schools, today - 3)
```

```{r}
# get school covid adta
import_covid_schools <- function() {
  q <- "https://analisi.transparenciacatalunya.cat/resource/fk8v-uqfv.json"
  df <- read.socrata(q, stringsAsFactors = F) %>%
    mutate(
      datageneracio = as.character(datageneracio)
    ) %>%
    select(-datacreacio)
}

df_schools <- import_covid_schools() 
```

```{r}
# format wide
df <- df_schools %>% 
  mutate_each_(
    funs(as.numeric), 
    c("personal_positiu_acum", "altres_positiu_acum", "alumn_positiu_acum", "grup_confin", "codcentre")
  ) %>%
  mutate(
    total = personal_positiu_acum + altres_positiu_acum + alumn_positiu_acum,
    personal = personal_positiu_acum + altres_positiu_acum,
    alumnes = alumn_positiu_acum,
    
  ) %>%
  pivot_longer(
    cols = c("total", "personal", "alumnes", "grup_confin"),
    names_to = "population"
  ) %>%
  pivot_wider(
    id_cols = c("codcentre", "population"),
    names_from = datageneracio,
    values_from = value
    ) 
```


```{r}
# import general school data (the api is not correctly formatted, so i'll do i from the file)
schools <- readxl::read_xlsx(file.path("..", "data", "escoles_base.xlsx")) %>%
  filter(`Codi centre` != 1) 
```

```{r}
# merge school and covid school data
tot <- schools %>%
  left_join(df,
            by = c("Codi centre" = "codcentre"),
            suffix = c("", "")) %>%
  mutate_at(35:ncol(.), as.numeric)
```

```{r}
# we have acc cases, we compute new cases
tt <- tot
num_ <- 35
no_grup <- - which(tot$population == "grup_confin")
for (i in (num_ + 1):ncol(tot)) {
  tt[no_grup, i] <- tot[no_grup, i] - apply(tot[no_grup, num_:(i - 1)], 1, max)
}
# sometimes the acc cases are lower in the future, i guess they are errors and we set these -1 to 0
tt[no_grup, num_:ncol(tt)] <- apply(tt[no_grup, num_:ncol(tt)], 2, function(x) ifelse(x < 0, 0, x))
```

# Càlcul rho0 intra centre

En aquets apartat mirem, després de que aparegui un cas en un centre, quants altres n'apareixen, que assumim que són contagis d'aquest primer. Això és una assumpció forta i estarà violada aleatòriament, però com a primera aproximació ens serà útil:

Assumim que els infants i adolescents poden ser contagiosos durant 14 dies després d'emmalaltir. Això és equivalent a 10 dies laborables, que és en el format que tenim les dades.

*Nota:* potser s'haurà de fer alguna correcció pels festius.

Ara fem el càlcul de a quantes persones contagia cada alumne. Per fer-ho, però, hem de primer fer assumpcions sobre com d'estancs són els grups bombolla. El rang va de que hi ha 0 transmissió entre grups, és a dir, que cada cas en un altre grup confinat és un cas independent, fins a 1, que vol dir que no hi ha bombolles i que tots els casos d'una escola provenen del mateix cas índex. Evidentment la realitat marginal estarà en algun lloc de per aquí al mig, així que per ara fem un paràmetre per controlar aquest valor i ja mirarem d'ajustar-lo.

```{r}
# how leaky are bubbles?
leak <- 0.2

correct_leak <- function(x, l) {
  l * (1 - x) + x
}
```

Fem un primer anàlisi ajuntant alumnes i mestres:

```{r}
tam <- tt %>% 
  filter(population %in% c("total", "grup_confin"))
```

```{r}
grups <- which(tam$population == "grup_confin")
dur_ <- 10
end_ <- ncol(tt) - dur_
tam <- as.data.frame(tam)
rho_df <- tam[-grups, 1:end_]
for (i in (num_ + 1):end_) {
  rho_df[, i] <- ifelse(
    tam[-grups, i] == 0,
    NA,
    (rowSums(tam[-grups, i:(i + dur_)]) - 1) / correct_leak(
      apply(cbind(apply(tam[grups, i:(i + dur_)], 1, max), 
                                                           rep(1, nrow(tam[grups, ]))), 1, max),
    leak
    )
  )
}
```

Fem la mitjana:

```{r}
# remove the first point because it's weird
rho_average <- as.data.frame(apply(rho_df[, (num_ + 1):end], 2, function(x) mean(x, na.rm = T))) %>% 
  rename_all(funs(c("rho"))) %>%
  mutate(
    date = rownames(.),
    avg_5day = zoo::rollmean(rho, 5, fill = NA, align = "right")
  )

```

```{r}
fig <- plot_ly(rho_average, x = ~ date)
fig <- fig %>% add_trace(y = ~ rho, name = "Rho mitjana", type = "scatter", mode = "lines")
fig <- fig %>% add_trace(y = ~ avg_5day, name = "7 day average", type = "scatter", mode = "lines")

fig

```

