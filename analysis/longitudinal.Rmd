---
title: "Anàlisis evolució COVID escoles"
author: "Projecte Òrbita"
date: "23/10/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lubridate)
library(RSocrata)
library(dplyr)
library(tidyr)
library(plotly)
enc <- "UTF-8"
```

```{r}
# TODO: get from other code
import_covid <- function(start, end) {
  # Import COVID cases from API
  # TODO: filter by date already in the query
  p <- "https://analisi.transparenciacatalunya.cat/resource/jj6z-iyrp.json"
  q <- "?$where=resultatcoviddescripcio='Positiu PCR'"
  l <- paste0(p, q)
  covid <- read.socrata(l, stringsAsFactors = F)

  covid$data <- ymd(covid$data)
  covid <- covid[(covid$data > start & covid$data < end), ]

  covid
}
```

```{r}
# define vars
start_schools <- ymd("2020-09-14")
today <- today()
correction <- 3
```

```{r}
# get population covid data
df_pop <- import_covid(start_schools, today - 3)
```

```{r}
# get school covid adta
import_covid_schools <- function() {
  q <- "https://analisi.transparenciacatalunya.cat/resource/fk8v-uqfv.json"
  df <- read.socrata(q, stringsAsFactors = F) %>%
    mutate(
      datageneracio = as.character(datageneracio)
    ) %>%
    select(-datacreacio)
}

df_schools <- import_covid_schools() 
```

```{r}
# format wide
df <- df_schools %>% 
  mutate(
    personal = as.numeric(personal_positiu_acum) + as.numeric(altres_positiu_acum),
    alumnes = as.numeric(alumn_positiu_acum),
    codcentre = as.numeric(codcentre)
    
  ) %>%
  pivot_longer(
    cols = c("personal_positiu_acum", "alumn_positiu_acum"),
    names_to = "population"
  ) %>%
  pivot_wider(
    id_cols = c("codcentre", "population"),
    names_from = datageneracio,
    values_from = value
    ) 
```


```{r}
# import general school data (the api is not correctly formatted, so i'll do i from the file)
schools <- readxl::read_xlsx(file.path("..", "data", "escoles_base.xlsx")) %>%
  filter(`Codi centre` != 1) 
```

```{r}
# merge school and covid school data
tot <- schools %>%
  left_join(df,
            by = c("Codi centre" = "codcentre"),
            suffix = c("", "")) %>%
  mutate_at(35:ncol(.), as.numeric)
```

```{r}
# we have acc cases, we compute new cases
tt <- tot
num_ <- 35
for (i in (num_ + 1):ncol(tot)) {
  tt[, i] <- tot[, i] - apply(tot[, num_:(i - 1)], 1, max)
}
# sometimes the acc cases are lower in the future, i guess they are errors and we set these -1 to 0
tt[, num_:ncol(tt)] <- apply(tt[, num_:ncol(tt)], 2, function(x) ifelse(x < 0, 0, x))
```

# Càlcul rho0 intra centre

En aquets apartat mirem, després de que aparegui un cas en un centre, quants altres n'apareixen, que assumim que són contagis d'aquest primer. Això és una assumpció forta i estarà violada aleatòriament, però com a primera aproximació ens serà útil:

Assumim que els infants i adolescents poden ser contagiosos durant 14 dies després d'emmalaltir. Això és equivalent a 10 dies laborables, que és en el format que tenim les dades.

*Nota:* potser s'haurà de fer alguna correcció pels festius.

Si dos casos apareixen a la vegada assumim que un d'ells és un contagi de l'altre.

```{r}
dur_ <- 10
end <- ncol(tt) - dur_
rho_df <- tt[, 1:end]
for (i in (num_ + 1):end) {
  rho_df[, i] <- ifelse(tt[, i] == 0, NA, rowSums(tt[, i:(i + dur_)]) - 1)
}
```

Fem la mitjana:

```{r}
# remove the first point because it's weird
rho_average <- as.data.frame(apply(rho_df[, (num_ + 1):end], 2, function(x) mean(x, na.rm = T))) %>% 
  rename_all(funs(c("rho"))) %>%
  mutate(
    date = rownames(.),
    avg_5day = zoo::rollmean(rho, 5, fill = NA, align = "right")
  )

```

```{r}
fig <- plot_ly(rho_average, x = ~ date)
fig <- fig %>% add_trace(y = ~ rho, name = "Rho mitjana", type = "scatter", mode = "lines")
fig <- fig %>% add_trace(y = ~ avg_5day, name = "7 day average", type = "scatter", mode = "lines")

fig

```

