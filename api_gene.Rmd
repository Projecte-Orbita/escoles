---
title: "API gene"
author: "Projecte Òrbita"
date: "10/9/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lubridate)
library(dplyr)
library(tidyr)
library(leaflet)
library(mapview)
days_back <- 14
correction <- 3  # Data from last 3 days is no good
```

```{r}
today <- today()
start <- today - days_back - correction - 1
week <- today - 7 - correction - 1
end <- today - correction

# TODO: filter also by date
p <- "https://analisi.transparenciacatalunya.cat/resource/jj6z-iyrp.json"
q <- "?$where=resultatcoviddescripcio='Positiu PCR'"
l <- paste0(p, q)
df <- RSocrata::read.socrata(l, stringsAsFactors = F)
```

Filter by date:

```{r}
df$data <- ymd(df$data)
df <- df[(df$data > start & df$data < end), ]
```

```{r}
wt <- tidyr::pivot_wider(
  df %>% 
    mutate_at("numcasos", as.numeric) %>%
    group_by(data, municipicodi) %>% 
    summarise_at("numcasos", sum, na.rm = TRUE),
  id_cols = "municipicodi",
  names_from = "data",
  values_from = "numcasos"
) %>% filter(!is.na(municipicodi)) %>%
  mutate_all(., ~ replace(., is.na(.), 0))
acc_wt <- wt %>%  pivot_longer(-"municipicodi") %>%
  pivot_wider(names_from = municipicodi, values_from = value) %>%
  mutate_at(-1, cumsum) %>%
  pivot_longer(-"name", names_repair = c("unique")) %>%
  rename_all(funs(c("name", "code", "value"))) %>%
  pivot_wider(names_from = name, values_from = value)
```

Compute $\rho_7$ according to biocosmc function (here: https://biocomsc.upc.edu/en/shared/avaluacio_risc.pdf). They don't say it but we correct for infinite rhos:

```{r}
compute_rho <- function(x) {
  rowSums(x[, (ncol(x) - 3):ncol(x)]) / pmax(rowSums(x[, (ncol(x) - 7):(ncol(x) - 4)]), 1)
}
rho <- 0
for (i in 1:7) {
  rho <- rho + compute_rho(wt[, 2:(ncol(wt) - i + 1)]) / 7
}
wt$rho <- rho
```


```{r, eval=F}
names(wt) <- paste0("c", names(wt))
wt$day <- 1:7
slope <- function(y) coef(lm(y ~ day, data = wt))[2]

rho <- sapply(wt[, -1], slope)
rhos <- cbind.data.frame(names(wt[-1]), rho)
names(rhos) <- c("code", "rho")
rhos$code <- substr(rhos$code, 2, 6)
rownames(rhos) <- 1:nrow(rhos)
```

We also want to store the new cases on the last day:

```{r}
last <- df[(df$data > end - correction), c("municipicodi", "numcasos")] %>%
  mutate_at("numcasos", as.numeric) %>%
  group_by(municipicodi) %>%
  summarise(across(numcasos, sum, na.rm = TRUE))
names(last)[2] <- "casos_24h"
```

Now we aggregate over the last two weeks:

```{r}
tt <- df %>% 
  mutate(across("numcasos", as.numeric)) %>% 
  group_by(municipicodi) %>% 
  summarise(across("numcasos", sum, na.rm = TRUE))
```

Put it together:

```{r}
aa <- tt %>% full_join(last, by = "municipicodi")
aa <- aa %>% full_join(wt[, c("municipicodi", "rho")])
```

Some have accumulatd cases but have had none in the previous week. Fix missing:

```{r}
aa <- aa %>% mutate(across(c(casos_24h, rho), ~replace(., is.na(.), 0))) %>% drop_na
```


Get population by municipality from here (beware, you need to correctly format the xls file by hand first):

https://www.idescat.cat/pub/?id=aec&n=925

Furthermore, population data has a 6 digit code for municipalities, whereas covid cases data only 5. We have removed the last digit of the population data and it seems to match. TODO: check this.

```{r}
pb <- readxl::read_excel("escoles/data/municipis.xlsx")
pb$Codi <- substr(pb$Codi, 1, 5)
```

Put stuff together

```{r}
jn <- pb %>% full_join(aa, by = c("Codi" = "municipicodi"))
```

Remove villages with unknown population and set all villages with unkown case number to 0:

```{r}
jn <- jn %>% 
  filter(!is.na(Població)) %>% 
  mutate(across(c(numcasos, casos_24h, rho), ~replace(., is.na(.), 0)))
```

Compute the 100.000 people ratio and the EPG (risc de rebrot):

```{r}
num_ <- 10^5
jn <- jn %>% 
  mutate(taxa_incidencia_14d = numcasos / Població * num_, 
         taxa_casos_nous = casos_24h / Població * num_,
         epg = taxa_incidencia_14d * rho
         )
```

Load mapping data:

```{r}
library(sf)
map <- st_read(file.path("escoles", "mapes", "bm5mv21sh0tpm1_20200601_0.shp"))
map$CODIMUNI <- substr(map$CODIMUNI, 1, 5)
```

Put everything together

```{r}
df <- st_transform(st_as_sf(jn %>% inner_join(map, by = c("Codi" = "CODIMUNI"))), "+proj=longlat +datum=WGS84") 
```

Upload schools

```{r}
esc <- read.csv(file.path("escoles", "escoles", "totcat_nivells_junts.csv"), sep = ";", dec=",", encoding = "UTF-8")
esc$estat <- "normal"
```

# Plot

Icones:

```{r}
wdt <- 14
hgt <- 12
icones_escoles <- icons(
  iconUrl = esc %>% mutate(
    icona = case_when(
      estat == "normal" ~ "escoles/icones/escola_verda.png",
      estat == "casos" ~ "escoles/icones/escola_taronja.png",
      estat == "tancada" ~ "escoles/icones/escola_vermella.png",
      TRUE ~ "escoles/icones/escola_negra.png"
    )
  ) %>% pull(icona),
  iconWidth = wdt, iconHeight = hgt,
  iconAnchorX = wdt/2, iconAnchorY = hgt/2,
)
getColor <- function(quakes) {
  sapply(quakes$mag, function(mag) {
  if(mag <= 4) {
    "green"
  } else if(mag <= 5) {
    "orange"
  } else {
    "red"
  } })
}

icons <- awesomeIcons(
  icon = 'ios-close',
  iconColor = 'black',
  library = 'ion',
  markerColor = esc %>% mutate(
    icona = case_when(
      estat == "normal" ~ "chartreuse1",
      estat == "casos" ~ "orange1",
      estat == "tancada" ~ "firebrick1",
      TRUE ~ "black"
    )
  ) %>% pull(icona)
)
```

```{r}
# pal <- colorNumeric(palette = "heat", domain = log(df$epg + 1), reverse = T)
pal <- wesanderson::wes_palette("Zissou1", 100, type = "continuous")
leaflet() %>%
  addProviderTiles(provider = providers$CartoDB.Positron) %>%
  setView(lat = 41.7, lng = 2, zoom = 8) %>%
  addPolygons(
    data = df,
    weight = 2,
    smoothFactor = 0.2,
    fillOpacity = .7,
    color = ~ pal,
    label = df$Municipi,
    popup = df$Municipi
  ) %>%
  addMarkers(
    esc$Coordenades.GEO.X,
    esc$Coordenades.GEO.Y,
    popup = as.character(esc$Denominació.completa),
    label = as.character(esc$Denominació.completa),
    icon = icones_escoles,
    options = providerTileOptions(updateWhenZooming = FALSE,
                                  updateWhenIdle = TRUE)
  )
```

